<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>äºŒæ°§åŒ–ç¢³æ’æ”¾è¨ˆç®—å™¨</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap" rel="stylesheet">
<style>
body { font-family: 'Noto Sans TC', sans-serif; margin: 30px; background: #f4f6f8; color:#2c3e50; }
h2 { color: #2c3e50; margin-bottom: 10px;}
.card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 25px;}
.item { margin: 10px 0; }
input, select { padding: 6px 10px; margin-left: 10px; border:1px solid #ccc; border-radius:6px; }
button { margin:5px 5px 0 0; padding: 10px 18px; border:none; border-radius:8px; cursor:pointer; color:#fff; font-weight:bold; background: linear-gradient(45deg,#3498db,#27ae60); transition:0.3s;}
button:hover { filter: brightness(1.1);}
.result { margin-top: 15px; font-size: 18px; font-weight:bold; color:#e74c3c; }
table { margin-top: 15px; border-collapse: collapse; width: 100%; max-width: 720px; background:#fff; border-radius:8px; overflow:hidden;}
table, th, td { border:1px solid #ddd; }
th, td { padding: 10px; text-align: center; }
th { background:#3498db; color:#fff;}
#chart-container, #history-chart { margin-top: 25px; max-width: 720px; background:#fff; padding:15px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08);}
</style>
</head>
<body>

<h2>äºŒæ°§åŒ–ç¢³æ’æ”¾è¨ˆç®—å™¨</h2>

<div class="card">
  <h3>ğŸ“… è¨­å®šæœŸé–“</h3>
  <div class="item">
    å¹´åº¦
    <select id="year"></select>
    æœˆä»½
    <select id="month">
      <option value="1">1 æœˆ</option>
      <option value="2">2 æœˆ</option>
      <option value="3">3 æœˆ</option>
      <option value="4">4 æœˆ</option>
      <option value="5">5 æœˆ</option>
      <option value="6">6 æœˆ</option>
      <option value="7">7 æœˆ</option>
      <option value="8">8 æœˆ</option>
      <option value="9">9 æœˆ</option>
      <option value="10">10 æœˆ</option>
      <option value="11">11 æœˆ</option>
      <option value="12">12 æœˆ</option>
    </select>
  </div>

  <h3>ğŸ’§ è¼¸å…¥ç”¨é‡</h3>
  <div class="item">é›»åŠ› (åº¦) <input type="number" id="electricity" value="0"></div>
  <div class="item">æ°´ (åº¦) <input type="number" id="water" value="0"></div>
  <div class="item">æŸ´æ²¹ (L) <input type="number" id="diesel" value="0"></div>
  <div class="item">è»Šç”¨æ±½æ²¹ (L) <input type="number" id="gasoline" value="0"></div>
  <div class="item">ç‡ƒæ–™æ²¹ (L) <input type="number" id="fuelOil" value="0"></div>
  <div class="item">å¤©ç„¶æ°£ (mÂ³) <input type="number" id="ng" value="0"></div>
  <div class="item">æ¶²åŒ–çŸ³æ²¹æ°£ (L) <input type="number" id="lpg" value="0"></div>

  <button onclick="calculate()">è¨ˆç®—æ’æ”¾é‡</button>
</div>

<div class="card">
  <div class="result" id="result">ç¸½æ’æ”¾é‡ï¼š0 KgCOâ‚‚e</div>

  <table id="details">
    <thead>
      <tr><th>é …ç›®</th><th>ç”¨é‡</th><th>æ’æ”¾é‡ (KgCOâ‚‚e)</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="chart-container">
    <canvas id="emissionChart"></canvas>
  </div>
</div>

<div class="card">
  <h3>ğŸ“Š æ­·å²ç´€éŒ„</h3>
  <table id="historyTable">
    <thead><tr><th>æœŸé–“</th><th>ç¸½æ’æ”¾é‡ (KgCOâ‚‚e)</th></tr></thead>
    <tbody></tbody>
  </table>

  <div id="history-chart">
    <canvas id="historyChartCanvas"></canvas>
  </div>
</div>

<div class="card">
  <button onclick="exportExcel()">åŒ¯å‡º Excel (å–®æœˆ)</button>
  <button onclick="exportPDF()">åŒ¯å‡º PDF (å–®æœˆ)</button>
  <button onclick="exportHistoryExcel()">åŒ¯å‡º Excel (æ­·å²)</button>
  <button onclick="exportHistoryPDF()">åŒ¯å‡º PDF (æ­·å²)</button>
  <input type="file" id="importFile" accept=".xlsx,.xls" onchange="importHistoryExcel()" style="margin-left:10px;">
  <label for="importFile" style="cursor:pointer; color:#2980b9;">ğŸ“¥ åŒ¯å…¥ Excel (æ­·å²)</label>
</div>

<script>
// åˆå§‹åŒ–å¹´ä»½
(function() {
  const yearSelect = document.getElementById("year");
  const currentYear = new Date().getFullYear();
  for(let y=currentYear; y>=currentYear-10; y--){
    let opt=document.createElement("option"); opt.value=y; opt.textContent=y;
    yearSelect.appendChild(opt);
  }
  yearSelect.value=currentYear;
})();

// CO2 æ’æ”¾ä¿‚æ•¸
const emissionFactors = {
  electricity: 0.474,
  water: 0.156,
  diesel: 2.606,
  gasoline: 2.322,
  fuelOil: 3.114,
  ng: 2.204,
  lpg: 1.519
};

let history = JSON.parse(localStorage.getItem("co2History") || "[]");

function calculate() {
  const year = document.getElementById("year").value;
  const month = document.getElementById("month").value;

  const data = {
    electricity: parseFloat(document.getElementById("electricity").value) || 0,
    water: parseFloat(document.getElementById("water").value) || 0,
    diesel: parseFloat(document.getElementById("diesel").value) || 0,
    gasoline: parseFloat(document.getElementById("gasoline").value) || 0,
    fuelOil: parseFloat(document.getElementById("fuelOil").value) || 0,
    ng: parseFloat(document.getElementById("ng").value) || 0,
    lpg: parseFloat(document.getElementById("lpg").value) || 0
  };

  const detailsTbody = document.querySelector("#details tbody");
  detailsTbody.innerHTML = "";

  let total = 0;
  for (let key in data) {
    let emission = (data[key] * emissionFactors[key]).toFixed(2);
    total += parseFloat(emission);
    let tr = document.createElement("tr");
    tr.innerHTML = `<td>${key}</td><td>${data[key]}</td><td>${emission}</td>`;
    detailsTbody.appendChild(tr);
  }

  document.getElementById("result").textContent = `ç¸½æ’æ”¾é‡ï¼š${total.toFixed(2)} KgCOâ‚‚e`;

  // ä¿å­˜æ­·å²
  const period = `${year}-${month.padStart(2,'0')}`;
  history = history.filter(h => h.period !== period);
  history.push({ period, total: total.toFixed(2) });
  history.sort((a,b)=> a.period.localeCompare(b.period));
  localStorage.setItem("co2History", JSON.stringify(history));

  updateHistoryTable();
  renderChart(data);
  renderHistoryChart();
}

function updateHistoryTable() {
  const tbody = document.querySelector("#historyTable tbody");
  tbody.innerHTML = "";
  history.forEach(h=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${h.period}</td><td>${h.total}</td>`;
    tbody.appendChild(tr);
  });
}

function renderChart(data) {
  const ctx = document.getElementById("emissionChart").getContext("2d");
  if(window.emissionChart) window.emissionChart.destroy();
  window.emissionChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: Object.keys(data),
      datasets: [{
        label: "æ’æ”¾é‡ KgCOâ‚‚e",
        data: Object.keys(data).map(k => (data[k]*emissionFactors[k]).toFixed(2)),
        backgroundColor: "#3498db"
      }]
    },
    options: { responsive:true }
  });
}

function renderHistoryChart() {
  const ctx = document.getElementById("historyChartCanvas").getContext("2d");
  if(window.historyChart) window.historyChart.destroy();
  window.historyChart = new Chart(ctx, {
    type: "line",
    data: {
      labels: history.map(h=>h.period),
      datasets: [{
        label:"æ­·å²ç¸½æ’æ”¾é‡",
        data: history.map(h=>h.total),
        fill:false,
        borderColor:"#27ae60",
        tension:0.2
      }]
    },
    options:{ responsive:true }
  });
}

// åŒ¯å‡ºå–®æœˆ Excel
function exportExcel() {
  const wb = XLSX.utils.book_new();
  const ws_data = [["é …ç›®","ç”¨é‡","æ’æ”¾é‡(KgCO2e)"]];
  const tbody = document.querySelector("#details tbody");
  tbody.querySelectorAll("tr").forEach(tr=>{
    ws_data.push(Array.from(tr.children).map(td=>td.textContent));
  });
  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb, ws, "å–®æœˆæ’æ”¾");
  XLSX.writeFile(wb, "CO2å–®æœˆæ’æ”¾.xlsx");
}

// åŒ¯å‡ºå–®æœˆ PDF
function exportPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text("å–®æœˆ CO2 æ’æ”¾æ˜ç´°", 14, 20);
  doc.autoTable({ html: "#details", startY: 30 });
  doc.save("CO2å–®æœˆæ’æ”¾.pdf");
}

// åŒ¯å‡ºæ­·å² Excel
function exportHistoryExcel() {
  const wb = XLSX.utils.book_new();
  const ws_data = [["æœŸé–“","ç¸½æ’æ”¾é‡(KgCO2e)"]];
  history.forEach(h=>ws_data.push([h.period,h.total]));
  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb, ws, "æ­·å²æ’æ”¾");
  XLSX.writeFile(wb, "CO2æ­·å²æ’æ”¾.xlsx");
}

// åŒ¯å‡ºæ­·å² PDF
function exportHistoryPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text("æ­·å² CO2 æ’æ”¾è¨˜éŒ„", 14, 20);
  doc.autoTable({
    head: [["æœŸé–“","ç¸½æ’æ”¾é‡(KgCO2e)"]],
    body: history.map(h=>[h.period,h.total]),
    startY: 30
  });
  doc.save("CO2æ­·å²æ’æ”¾.pdf");
}

// åŒ¯å…¥ Excel æ­·å²
function importHistoryExcel() {
  const file = document.getElementById("importFile").files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(e){
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, {type:"array"});
    const ws = workbook.Sheets[workbook.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(ws,{header:1});
    // å‡è¨­ç¬¬ä¸€åˆ—æ˜¯æ¨™é¡Œ
    history = [];
    for(let i=1;i<json.length;i++){
      const row = json[i];
      if(row[0] && row[1]) history.push({period:row[0], total:row[1]});
    }
    history.sort((a,b)=> a.period.localeCompare(b.period));
    localStorage.setItem("co2History", JSON.stringify(history));
    updateHistoryTable();
    renderHistoryChart();
    alert("æ­·å²è³‡æ–™åŒ¯å…¥å®Œæˆï¼");
  };
  reader.readAsArrayBuffer(file);
}

// åˆå§‹åŒ–
updateHistoryTable();
renderHistoryChart();
</script>

</body>
</html>
